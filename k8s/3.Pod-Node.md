# Tìm hiểu về POD và Node trong Kubernetes

> Tìm hiểu khái niệm về POD, cách khai báo tạo ra các POD manifest từ cấu hình yaml, chạy các POD và quản lý các POD tronng Kubernetes, xem log của POD, xóa POD ...

Lệnh kubectl tương tác với Cluster, cú pháp chính: 

> kubectl **[command]** **[TYPE]** **[NAME]** **[flags]**

Trong đó:

* **[command]** là lệnh, hành động như apply, get, delete, describe ...
* **[TYPE]** kiểu tài nguyên như ns, no, po, svc ...
* **[NAME]** tên đối tượng lệnh tác động
* **[flags]** các thiết lập, tùy thuộc loại lệnh

Lệnh | Diến giải
-----|----------
kubectl get nodes | Danh sách các Node trong Cluster
kubectl describe node name-node | Thông tin chi tiết về Node có tên name-node
kubectl get pods | Liệt kê các POD trong namespace hiện tại, thêm tham số -o wide hiện thị chi tiết hơn, thêm -A hiện thị tất cả namespace, thêm -n namespacename hiện thị Pod của namespace namespacename
kubectl explain pod --recursive=true | Xem cấu trúc mẫu định nghĩa POD trong file cấu hình yaml
kubectl apply -f firstpod.yaml | Triển khai tạo các tài nguyên định nghĩa trong file firstpod.yaml
kubectl delete -f firstpod.yaml | Xóa các tài nguyên tạo ra từ định nghĩa firstpod.yaml
kubectl describe pod/namepod | Lấy thông tin chi tiết POD có tên namepod, nếu POD trong namespace khác mặc định thêm vào tham số -n namespace-name
kubectl logs pod/podname | Xem logs của POD có tên podname
kubectl exec mypod command | Chạy lệnh từ container của POD có tên mypod, nếu POD có nhiều container thêm vào tham số -c và tên container
kubectl exec -it mypod bash | Chạy lệnh bash của container trong POD mypod và gắn terminal
kubectl proxy | Tạo server proxy truy cập đến các tài nguyên của Cluster. http://localhost/api/v1/namespaces/default/pods/mypod:8085/proxy/, truy cập đến container có tên mypod trong namespace mặc định.
kubectl delete pod/mypod | Xóa POD có tên mypod


## Node trong Kubernetes

* Trong Kubernetes Node là đơn vị nhỏ nhất xét về phần cứng. Nó là một máy vật lý hay máy ảo (VPS) trong cụm máy (cluster). Xem các nút (node) trong cụm (cluster) chạy lệnh:

> kubectl get nodes

![nodes](https://raw.githubusercontent.com/xuanthulabnet/learn-kubernetes/master/imgs/kubernetes016.png)

* Để lấy thông tin chi tiết về một Node nào đó như tài nguyên bộ nhớ, CPU, các container ... sử dụng lệnh:

> kubectl describe node tên-node

![describe node](https://raw.githubusercontent.com/xuanthulabnet/learn-kubernetes/master/imgs/kubernetes017.png)

#### Addresses

* **HostName**: Hostname của node
* **InternalIP**: địa chỉ IP của node sử dụng trong nội bộ Cluster
* **ExternalIP**: địa chỉ IP của node có hiểu lực từ ngoài cluster liên lạc đến

#### Conditions
Thông tin trạng thái đang chạy của node, có các thông tin

* Ready: giá trị **true** - chấp nhận triển khai chạy các Pod
* MemoryPressure: giá trị **true** nếu cạn kiệt bộ nhớ
* DiskPressure: giá trị **true** nếu cạn kiệt đĩa lưu trữ
* NetworkUnavailable: giá trị **true** nếu cấu hình mạng lỗi

#### Capacity / Allocatable

Capacity cho biết tài nguyên có hiệu lực như CPU, bộ nhớ, số pod có thể chạy ... Allocatable

#### System Info

Các thông tin phần mềm trên hệ thống

#### Nhãn của Node

Thiết lập nhãn

> kubectl label node worker1.xtl tennhan=giatrinhan

Lấy các tài nguyên có nhãn nào đó

> kubectl get node -l "tennhan=giatrinhan"

Xóa nhãn

> kubectl label node worker1.xtl tennhan-

# Pods trong Kubernetes

## Khái niệm Pod

> Kubernetes không chạy các container một cách trực tiếp, thay vào đó nó bọc một hoặc vài container vào với nhau trong một cấu trúc gọi là POD. Các container cùng một pod thì chia sẻ với nhau tài nguyên và mạng cục bộ của pod.

![Pod](https://raw.githubusercontent.com/xuanthulabnet/learn-kubernetes/master/imgs/kubernetes018.png)

> Pod là thành phần đơn vị (nhỏ nhất) để Kubernetes thực hiện việc nhân bản (replication), có nghĩa là khi cần thiết thì Kubernetes có thể cấu hình để triển khai nhân bản ra nhiều pod có chức năng giống nhau để tránh quá tải, thậm chí nó vẫn tạo ra nhiều bản copy của pod khi không quá tải nhằm phòng lỗi (ví dụ node bị die).

> Pod có thể có nhiều container mà pod là đơn vị để scale (có nghĩa là tất cả các container trong pod cũng scale theo) nên nếu có thể thì cấu hình ứng dụng sao cho một Pod có ít container nhất càng tốt.

* Cách sử dụng hiệu quả và thông dụng là dùng loại Pod trong nó chỉ chạy một container.
* Pod loại chạy nhiều container trong đó thường là đóng gọi một ứng dụng xây dựng với sự phối hợp chặt chẽ từ nhiều container trong một khu vực cách ly, chúng chia sẻ tài nguyên ổ đĩa, mạng cho nhau.

## Mạng / Volume với POD

> Bạn có thể tạo ra Pod một cách trực tiếp (thực tế ít dùng) hoặc qua triển khai Deployment để Controller thực hiện, khi Pod được tạo ra nó được lên kế hoạch chạy trong một Node nào đó của cụm máy, nó tồn tại cho đến khi tiến trình chạy kết thúc hoặc bị xóa, bị lỗi Node ...

> `Controller`: Khi bạn tạo các Pod không trực tiếp, tức thông qua cấu hình Deployment thì có một Controller thực hiện việc tạo quản lý các Pod cho bạn, thực hiện cách này nó cung cấp khả năng cập nhật giám sát, phục hồi ...

## Liệt kê các Pod

```
# Liệt kê các pod ở namespace mặc định
kubectl get pods

# Hiện thị nhiều thông tin hơn
kubectl get pod -o wide

# Pod ở namepace: kubernetes-dashboard
kubectl get pod -o wide -n kubernetes-dashboard

# Pod ở tất cả các namespace
kubectl get pod -A

# Liệt kê các Pod có nhãn app: mypod
kubectl get pod -l "app=mypod"
```

![Describe pod](https://raw.githubusercontent.com/xuanthulabnet/learn-kubernetes/master/imgs/kubernetes019.png)

## Tạo Pod từ file cấu hình .yaml


Có thể tạo Pod từ lệnh `kubectl run` tuy nhiên nên khai báo Pod trong file `config.yaml` rồi ra lệnh đọc file này và tạo pod với lệnh `kubectl apply`

Tạo ra một file đặt tên `1-swarmtest-node.yaml`, cấu trúc và các khai báo tham khảo với lệnh:

> kubectl explain pod --recursive=true

Tham khảo chi tiết: [Kubernetes API - Pod v1 core](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.16/#pod-v1-core)

**1-swarmtest-node.yaml**
```
apiVersion: v1
kind: Pod
metadata:
  labels:
    app: app1
    ungdung: ungdung1
  name: ungdungnode
spec:
  containers:
  - name: c1
    image: ichte/swarmtest:node
    resources:
      limits:
        memory: "150M"
        cpu: "100m"
    ports:
      - containerPort: 8085
      # - containerPort: 8086
```

File trên khai báo một Pod, đặt tên là `ungdungnode`, gán nhãn app: app1, ungdung: ungdung1 trong Pod chạy một Container từ image `ichte/swarmtest:php`, cổng của Container `8085`

> kubectl apply -f firstpod.yaml

> Mặc định Kubernetes không tạo và chạy POD ở Node Master để đảm bảo yêu cầu an toàn, nếu vẫn muốn chạy POD ở Master thi hành lệnh sau:

> kubectl taint nodes --all node-role.kubernetes.io/master-

Tương tự có thể tạo triển khai một POD chạy container chạy nginx

**2-nginx.yaml**

```
apiVersion: v1
kind: Pod
metadata:
  name: nginxapp
  labels:
    app: nginxapp
spec:
  containers:
  - name: n1
    image: nginx:1.17.6
    resources:
      limits:
        memory: "128Mi"
        cpu: "100m"
    ports:
      - containerPort: 80
```

Cũng khai báo một POD sử dụng Image `ichte/coretools` (một image từ [Dockerfile](https://github.com/xuanthulabnet/docker-testtools/blob/master/Dockerfile) với Debian có cài đặt một số công cụ như vim, curl, wget ... để kiểm tra )
